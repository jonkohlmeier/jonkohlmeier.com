---
import type { ImageMetadata } from 'astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import BaseHead from '../components/BaseHead.astro';

interface Props {
  title: string;
  description: string;
  image?: ImageMetadata;
  showHeader?: boolean;
  className?: string;
}

const { title, description, image, showHeader = true, className } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={title} description={description} image={image} />
    <script is:inline>
      (() => {
        if (typeof window === 'undefined') {
          return;
        }

        const storageKey = 'theme';
        const root = document.documentElement;
        const mediaQuery = window.matchMedia?.('(prefers-color-scheme: dark)');
        const toggles = new Set();
        let lastTheme;

        const storage = {
          get() {
            try {
              return localStorage.getItem(storageKey);
            } catch {
              return null;
            }
          },
          set(value) {
            try {
              localStorage.setItem(storageKey, value);
            } catch {
              /* ignore */
            }
          },
        };

        const syncToggleState = (theme) => {
          requestAnimationFrame(() => {
            toggles.forEach((button) => {
              button.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
            });
          });
        };

        const applyTheme = (value, { persist = true } = {}) => {
          const next = value === 'dark' ? 'dark' : 'light';
          if (lastTheme === next) {
            return next;
          }

          lastTheme = next;
          root.dataset.theme = next;
          root.style.colorScheme = next;

          if (persist) {
            storage.set(next);
          }

          syncToggleState(next);
          return next;
        };

        const initialTheme = storage.get() ?? (mediaQuery?.matches ? 'dark' : 'light');
        applyTheme(initialTheme, { persist: false });

        const toggleTheme = () => {
          applyTheme(lastTheme === 'dark' ? 'light' : 'dark');
        };

        const registerToggle = (button) => {
          if (toggles.has(button)) {
            return;
          }
          toggles.add(button);
          button.dataset.themeToggleBound = 'true';
          button.setAttribute('aria-pressed', lastTheme === 'dark' ? 'true' : 'false');
          button.addEventListener('click', toggleTheme);
        };

        const hydrateToggles = () => {
          document.querySelectorAll('[data-theme-toggle]').forEach(registerToggle);
        };

        const scheduleHydration = () => {
          const runner = () => hydrateToggles();
          if ('requestIdleCallback' in window) {
            requestIdleCallback(runner);
          } else {
            setTimeout(runner, 0);
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener(
            'DOMContentLoaded',
            () => {
              scheduleHydration();
            },
            { once: true },
          );
        } else {
          scheduleHydration();
        }

        mediaQuery?.addEventListener?.('change', (event) => {
          if (storage.get()) {
            return;
          }
          applyTheme(event.matches ? 'dark' : 'light', { persist: false });
        });
      })();
    </script>
  </head>
  <body>
    <a
      href="#page-content"
      class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:z-50 focus:rounded-full focus:bg-[var(--color-accent)] focus:px-4 focus:py-2 focus:text-sm focus:font-semibold focus:text-[var(--color-accent-contrast)]"
    >
      Skip to content
    </a>
    {showHeader && <Header />}
    <main id="page-content" class={`min-h-screen ${className ?? ''}`}>
      <slot />
    </main>
    <Footer />
  </body>
</html>
