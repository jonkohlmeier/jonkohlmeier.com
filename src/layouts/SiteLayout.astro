---
import type { ImageMetadata } from 'astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import BaseHead from '../components/BaseHead.astro';

interface Props {
  title: string;
  description: string;
  image?: ImageMetadata;
  showHeader?: boolean;
  className?: string;
}

const { title, description, image, showHeader = true, className } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={title} description={description} image={image} />
    <script is:inline>
      (() => {
        if (typeof window === 'undefined') {
          return;
        }

        const storageKey = 'theme';
        const root = document.documentElement;
        const mediaQuery = window.matchMedia?.('(prefers-color-scheme: dark)');

        const getStoredTheme = () => {
          try {
            return localStorage.getItem(storageKey);
          } catch (error) {
            return null;
          }
        };

        const storeTheme = (value) => {
          try {
            localStorage.setItem(storageKey, value);
          } catch (error) {
            /* ignore */
          }
        };

        const applyTheme = (value, { persist = true } = {}) => {
          const next = value === 'dark' ? 'dark' : 'light';
          if (persist) {
            storeTheme(next);
          }
          root.dataset.theme = next;
          root.style.colorScheme = next;

          document.querySelectorAll('[data-theme-toggle]').forEach((button) => {
            button.setAttribute('aria-pressed', next === 'dark' ? 'true' : 'false');
          });
        };

        const initialTheme = getStoredTheme() ?? (mediaQuery?.matches ? 'dark' : 'light');
        applyTheme(initialTheme, { persist: false });

        const toggleTheme = () => {
          const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
          applyTheme(next);
        };

        const bindToggles = () => {
          document.querySelectorAll('[data-theme-toggle]').forEach((button) => {
            if (button.dataset.themeToggleBound === 'true') {
              return;
            }
            button.dataset.themeToggleBound = 'true';
            button.addEventListener('click', toggleTheme);
          });
          applyTheme(root.dataset.theme, { persist: false });
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', bindToggles, { once: true });
        } else {
          bindToggles();
        }

        mediaQuery?.addEventListener?.('change', (event) => {
          if (getStoredTheme()) {
            return;
          }
          applyTheme(event.matches ? 'dark' : 'light', { persist: false });
        });
      })();
    </script>
  </head>
  <body>
    <a
      href="#page-content"
      class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:z-50 focus:rounded-full focus:bg-[var(--color-accent)] focus:px-4 focus:py-2 focus:text-sm focus:font-semibold focus:text-[var(--color-accent-contrast)]"
    >
      Skip to content
    </a>
    {showHeader && <Header />}
    <main id="page-content" class={`min-h-screen ${className ?? ''}`}>
      <slot />
    </main>
    <Footer />
  </body>
</html>
