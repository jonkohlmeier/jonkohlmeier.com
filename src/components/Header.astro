---
import ThemeToggle from './ThemeToggle.astro';
import { NAV_LINKS } from '../data/navigation';
import { SOCIAL_LINKS } from '../data/social';

const pathname = Astro.url.pathname.endsWith('/') ? Astro.url.pathname : `${Astro.url.pathname}/`;

const isActive = (href: string, aliases: string[] = []) => {
  if (href === '/') return pathname === '/';
  return pathname.startsWith(href) || aliases.some((alias) => pathname.startsWith(alias));
};

const iconMap: Record<string, string> = {
  linkedin: '<path d="M4.98 3.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5Zm.02 6H2v11h3V9.5Zm6.12 0H9v11h3v-5.7c0-1.47.7-2.3 1.91-2.3 1.1 0 1.79.74 1.79 2.3V20.5h3v-6.3c0-2.98-1.59-4.5-3.72-4.5-1.64 0-2.36.9-2.77 1.54V9.5Z" />',
  instagram:
    '<rect x="3" y="3" width="18" height="18" rx="4" /><path d="M9 12a3 3 0 1 0 6 0 3 3 0 0 0-6 0Z" /><circle cx="17" cy="7" r="1" />',
  rss: '<path d="M5 19a2 2 0 1 1 0-4 2 2 0 0 1 0 4Zm10-1H12c0-3.87-3.13-7-7-7V8c5.52 0 10 4.48 10 10Zm4 0h-3c0-6.63-5.37-12-12-12V3c8.28 0 15 6.72 15 15Z" />',
};
---
<header class="sticky top-0 z-40 border-b border-[var(--color-border)] bg-[var(--color-bg)]/92 supports-[backdrop-filter]:backdrop-blur-[20px]" style="min-height: 86px;">
  <div class="relative">
    <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_30%_100%,rgba(211,163,74,0.14),transparent_60%)] opacity-60"></div>
    <div class="container-page flex items-center justify-between gap-6 py-5">
      <a href="/" class="flex items-center gap-4 text-left">
        <div class="flex flex-col">
          <span class="brand-title text-2xl">Puffs of Smoke</span>
          <span class="brand-subtitle">Jon Kohlmeier</span>
        </div>
      </a>

      <nav class="hidden items-center justify-center gap-3 text-sm font-medium lg:flex">
        {NAV_LINKS.map((link) => {
          const active = !link.external && isActive(link.href, link.aliases);
          return (
            <a
              class={`nav-link ${active ? 'nav-link--active' : ''}`}
              href={link.href}
              target={link.external ? '_blank' : undefined}
              rel={link.external ? 'noopener noreferrer' : undefined}
            >
              {link.label}
            </a>
          );
        })}
      </nav>

      <div class="flex items-center gap-3">
        <div class="hidden items-center gap-2 lg:flex">
          {SOCIAL_LINKS.map((link) => (
            <a
              class="rounded-full border border-[var(--color-border)] bg-[var(--color-surface-muted)]/70 p-2 text-subtle transition hover:border-[var(--color-orange)] hover:text-[var(--color-orange)]"
              href={link.url}
              target={link.url.startsWith('/') ? undefined : '_blank'}
              rel={link.url.startsWith('/') ? undefined : 'noopener noreferrer'}
              aria-label={link.label}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                <g set:html={iconMap[link.name]} />
              </svg>
            </a>
          ))}
        </div>
        <ThemeToggle />
        <button
          class="btn-ghost border border-[var(--color-border)] px-3 py-2 text-subtle lg:hidden"
          type="button"
          aria-label="Toggle navigation"
          aria-expanded="false"
          data-mobile-toggle
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
            <path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="mobile-nav hidden border-t border-[var(--color-border)] bg-[var(--color-surface)] lg:hidden" data-mobile-menu>
    <div class="container-page flex flex-col gap-4 py-6">
      <nav class="flex flex-col gap-2">
        {NAV_LINKS.map((link) => {
          const active = !link.external && isActive(link.href, link.aliases);
          return (
            <a
              class={`rounded-full px-4 py-2 text-base font-medium transition ${
                active
                  ? 'bg-[var(--color-surface-muted)] text-[var(--color-accent)]'
                  : 'text-subtle hover:bg-[var(--color-surface-muted)]'
              }`}
              href={link.href}
              target={link.external ? '_blank' : undefined}
              rel={link.external ? 'noopener noreferrer' : undefined}
              data-mobile-link
            >
              {link.label}
            </a>
          );
        })}
      </nav>
      <div class="flex flex-wrap gap-3 text-xs uppercase tracking-[0.3em] text-subtle">
        {SOCIAL_LINKS.map((link) => (
          <a
            class="rounded-full border border-[var(--color-border)] px-3 py-1 hover:border-[var(--color-accent)] hover:text-[var(--color-accent)]"
            href={link.url}
            target={link.url.startsWith('/') ? undefined : '_blank'}
            rel={link.url.startsWith('/') ? undefined : 'noopener noreferrer'}
            data-mobile-link
          >
            {link.label}
          </a>
        ))}
      </div>
    </div>
  </div>
</header>

<script is:inline>
  const toggle = document.querySelector('[data-mobile-toggle]');
  const menu = document.querySelector('[data-mobile-menu]');
  const links = document.querySelectorAll('[data-mobile-link]');
  if (toggle && menu) {
    const closeMenu = () => {
      toggle.setAttribute('aria-expanded', 'false');
      menu.classList.add('hidden');
    };

    toggle.addEventListener('click', () => {
      const expanded = toggle.getAttribute('aria-expanded') === 'true';
      toggle.setAttribute('aria-expanded', (!expanded).toString());
      menu.classList.toggle('hidden');
    });

    links.forEach((link) => {
      link.addEventListener('click', () => closeMenu());
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1024) {
        closeMenu();
      }
    });
  }
</script>
